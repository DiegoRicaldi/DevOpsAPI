name: Node.js CI/CD

on:
  push:
    branches: [ "main" ]
# docker y docker hub
jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repository 
    - uses: actions/checkout@v4 


    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'

    - name: Install Dependencies
      run: npm ci

    - name: Run Tests
      run: npm test

    - name: Build Docker image
      run: docker build -t diegom648/devops .

    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_PASSWORD }}

    - name: Push Docker image to Docker Hub
      run: docker push diegom648/devops
    
  #render 
  deploy-to-render:
    needs: build-and-deploy
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to Render
        env:
          RENDER_API_KEY: ${{ secrets.RENDER_API_KEY }} 
          SERVICE_ID: ${{ secrets.SERVICE_ID }}  
        run: |
          echo "Deploying to Render..."
          curl -X POST \
            -H "Authorization: Bearer $RENDER_API_KEY" \
            -H "Content-Type: application/json" \
            -d '{
              "serviceId": "'"${srv-csf5219u0jms73fdb420}"'",
              "clearCache": true
            }' \
            https://api.render.com/v1/services/${srv-csf5219u0jms73fdb420}/deploys
    
